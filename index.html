<!doctype html>
<html lang="ko" class="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <title>SDN Food Booth Filter Â· Stable MVP</title>
  <style>
    /* ===================== THEME (Dark + Light) ===================== */
    :root{
      --bg:#0b0f1a; --bg-2:#0e1422; --surface:#111a2c; --surface-2:#0f1729; --border:#24314d;
      --text:#e9eef9; --muted:#9fb0c8;
      --brand:#4f7cff; --brand-2:#7cc5ff; --accent:#22c55e;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --radius:16px; --shadow:0 8px 28px rgba(0,0,0,.28);
      --tab-h:64px; --safe-bottom:env(safe-area-inset-bottom, 0px);
    }
    /* Light theme overrides (applied via html.light) */
    html.light{
      --bg:#f8fafc; --bg-2:#ffffff; --surface:#ffffff; --surface-2:#f3f6ff; --border:#d9e3ff;
      --text:#0b1426; --muted:#5c6d89;
      --brand:#2855ff; --brand-2:#55b5ff; --accent:#0ea5e9;
      --shadow:0 10px 26px rgba(12,30,60,.08);
    }

    *{box-sizing:border-box}
    html, body{height:100%}
    body{margin:0; background:linear-gradient(180deg, var(--bg), var(--bg-2)); color:var(--text); font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", "Apple SD Gothic Neo", Helvetica, Arial; -webkit-font-smoothing:antialiased}
    :focus-visible{outline:2px solid var(--brand); outline-offset:2px; border-radius:12px}

    /* ===================== LAYOUT ===================== */
    header{ position:sticky; top:0; z-index:20; background:color-mix(in oklab, var(--bg) 85%, transparent); backdrop-filter:saturate(160%) blur(14px); border-bottom:1px solid var(--border) }
    .wrap{ max-width:960px; margin:0 auto; padding:0 16px }
    main{ padding:16px 0 calc(var(--tab-h) + 18px + var(--safe-bottom)) }

    .row{ display:flex; align-items:center; gap:10px }
    .between{ justify-content:space-between }

    /* App Bar */
    .brand{ font-weight:900; letter-spacing:.2px; font-size:clamp(16px, 3vw, 18px) }
    .brand em{ background:linear-gradient(90deg, var(--brand), var(--accent)); -webkit-background-clip:text; background-clip:text; color:transparent; font-style:normal }
    .toolbar{ gap:8px }

    .iconbtn{ display:inline-flex; align-items:center; justify-content:center; width:40px; height:40px; border-radius:12px; background:transparent; border:1px solid transparent; color:var(--text); cursor:pointer }
    .iconbtn:hover{ background:color-mix(in oklab, var(--surface) 70%, transparent); border-color:var(--border) }

    select, input[type="search"]{ background:var(--surface-2); color:var(--text); border:1px solid var(--border); border-radius:14px; padding:12px 12px; }

    .card{ background:linear-gradient(180deg, var(--surface), var(--surface-2)); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px }
    .muted{ color:var(--muted); font-size:.93rem }

    .grid{ display:grid; gap:14px }
    .grid.cols-2{ grid-template-columns:1fr }
    @media(min-width:720px){ .grid.cols-2{ grid-template-columns:1fr 1fr } }

    .chips{ display:flex; gap:8px; overflow:auto; padding-bottom:2px; -webkit-overflow-scrolling:touch }
    .chip{ flex:0 0 auto; display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:color-mix(in oklab, var(--surface) 90%, transparent); border:1px solid var(--border); cursor:pointer; user-select:none; font-weight:600 }
    .chip.active{ box-shadow:inset 0 0 0 2px var(--brand) }

    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:12px 14px; border-radius:14px; border:1px solid var(--border); cursor:pointer; background:var(--brand); color:#fff; font-weight:800 }
    .btn.ghost{ background:transparent; color:var(--text); font-weight:700 }
    .btn.sm{ padding:8px 10px; border-radius:10px }

    .status{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:12px; font-weight:800 }
    .ok{ background:rgba(34,197,94,.12); color:#16a34a; border:1px solid rgba(34,197,94,.35) }
    .warn{ background:rgba(245,158,11,.12); color:#b45309; border:1px solid rgba(245,158,11,.35) }
    .bad{ background:rgba(239,68,68,.12); color:#b91c1c; border:1px solid rgba(239,68,68,.35) }

    .booth{ display:flex; gap:12px; align-items:flex-start }
    .booth .meta{ flex:1 }

    /* Sticky filters */
    .subhead{ position:sticky; top:64px; z-index:5; background:linear-gradient(180deg, var(--surface), var(--surface-2)); padding:12px 16px; margin:-16px -16px 8px; border-bottom:1px solid var(--border); border-radius:var(--radius) var(--radius) 0 0 }

    /* Bottom Tabs */
    .tabs{ position:fixed; bottom:0; left:0; right:0; display:grid; grid-template-columns:repeat(4,1fr); gap:8px; padding:10px 14px calc(10px + var(--safe-bottom)); background:color-mix(in oklab, var(--bg) 92%, transparent); border-top:1px solid var(--border); backdrop-filter:saturate(150%) blur(10px); height:var(--tab-h) }
    .tab{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; border-radius:12px; color:#4b5563; border:1px solid transparent; cursor:pointer }
    .tab.active{ background:rgba(79,124,255,.14); border-color:rgba(79,124,255,.35); color:#0b1426 }

    /* Toast */
    .toast{ position:fixed; left:50%; bottom:calc(var(--tab-h) + 12px + var(--safe-bottom)); transform:translateX(-50%); background:#0f172a; color:#e7ecf6; border:1px solid #263142; padding:10px 14px; border-radius:12px; opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:50 }
    .toast.show{ opacity:1 }

    /* Sheet (bottom drawer) */
    .sheet{ position:fixed; left:0; right:0; bottom:-100%; background:linear-gradient(180deg, var(--surface), var(--surface-2)); border-top-left-radius:24px; border-top-right-radius:24px; border:1px solid var(--border); box-shadow:var(--shadow); padding:16px; transition:bottom .25s ease; z-index:40 }
    .sheet.open{ bottom:calc(var(--safe-bottom)) }
    .sheet .handle{ width:48px; height:5px; border-radius:999px; background:color-mix(in oklab, var(--border) 40%, white 20%); margin:0 auto 10px }
  </style>
</head>
<body>
  <!-- App Bar -->
  <header>
    <div class="wrap row between" style="padding:12px 0">
      <div class="brand">ğŸ½ï¸ <em>SDN</em> Food Booth Filter</div>
      <div class="row toolbar">
        <select id="lang" title="Language">
          <option value="ko">í•œêµ­ì–´</option>
          <option value="en">English</option>
          <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
        </select>
        <button class="iconbtn" id="btnExport" title="ë‚´ë³´ë‚´ê¸°">â¬‡ï¸</button>
        <button class="iconbtn" id="btnTheme" title="í…Œë§ˆ ì „í™˜">ğŸŒ“</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- ì§€ë„ ì˜ì—­ ì¶”ê°€ -->
    <section id="mapSection" style="margin-bottom:18px;">
      <div id="mapContainer" style="width:100%;height:320px;border-radius:18px;overflow:hidden;position:relative;">
        <!-- ì§€ë„ iframe ë° ë§ˆì»¤ê°€ ë™ì ìœ¼ë¡œ ë Œë”ë§ë¨ -->
      </div>
    </section>
    <!-- Booths (default) -->
    <section id="view-booths" class="grid">
      <div class="card" id="welcome">
        <h2 style="margin:0 0 6px">í–‰ì‚¬ í‘¸ë“œ ë¶€ìŠ¤ í•œëˆˆì— í•„í„°ë§</h2>
        <p class="muted">ìƒë‹¨ ê²€ìƒ‰ì´ë‚˜ <b>âš™ï¸ í•„í„°</b>ë¡œ ë‚´ ê¸°ì¤€(í• ë„/ë¹„ê±´/ì•Œë ˆë¥´ê¸°) ì ìš© â†’ ì•„ë˜ ëª©ë¡ì´ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</p>
        <div class="row" style="gap:8px; margin-top:6px">
          <button class="btn sm" id="openSheetTop">âš™ï¸ í•„í„° ì—´ê¸°</button>
          <button class="btn ghost sm" id="seedData">ìƒ˜í”Œ ë°ì´í„° ì¬ì„¤ì •</button>
        </div>
      </div>

      <div class="card">
        <div class="subhead">
          <div class="row between" style="gap:8px">
            <input id="q" type="search" placeholder="ë¶€ìŠ¤Â·ë©”ë‰´Â·ì„±ë¶„ ê²€ìƒ‰ (ì˜ˆ: ë¹„ê±´, ë¼ì§€, ì•¡ì “)" style="flex:1" />
            <button class="btn ghost sm" id="openSheet">âš™ï¸ í•„í„°</button>
          </div>
          <div class="chips" id="quickChips" style="margin-top:10px">
            <div class="chip" data-quick="halalOnly">Halal Only</div>
            <div class="chip" data-quick="veganFriendly">Vegan Friendly</div>
            <div class="chip" data-quick="allergenSafe">Allergenâ€‘Safe</div>
          </div>
        </div>
        <div id="summary" class="muted" style="margin:4px 0 8px"></div>
        <div id="boothContainer" class="grid"></div>
        <div id="emptyState" class="muted" style="display:none; padding:12px 4px">ì¡°ê±´ì— ë§ëŠ” ë¶€ìŠ¤ë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš”. ê¸°ì¤€ì„ ì™„í™”í•´ ë³´ì„¸ìš”.</div>
      </div>
    </section>

    <!-- Detail -->
    <section id="view-detail" class="grid" style="display:none"></section>

    <!-- Admin -->
    <section id="view-admin" class="grid" style="display:none">
      <div class="card">
        <h2>íŒë§¤ì/ìš´ì˜ì ë©”ë‰´ ë“±ë¡</h2>
        <p class="muted">JSON/í…ìŠ¤íŠ¸ë¡œ ë©”ë‰´ë¥¼ ì¶”ê°€í•˜ì„¸ìš”. (ë¡œì»¬ ì €ì¥) Â· *ë³¸ ì„œë¹„ìŠ¤ëŠ” ì •ë³´ ì œê³µì´ë©° ì¸ì¦ì„ ëŒ€ì²´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
        <details><summary class="muted">í˜•ì‹ ì˜ˆì‹œ ë³´ê¸°</summary>
<pre style="white-space:pre-wrap; background:var(--surface-2); padding:12px; border-radius:12px; border:1px solid var(--border); overflow:auto">
[
  {"id":"B-12","name":"Kimbap House","halal_certified":false,
   "menus":[
     {"name":"ì±„ì‹ê¹€ë°¥","tags":["vegetarian"],"ingredients":["rice","seaweed","cucumber","carrot","spinach"],"note":"ê³„ë€ ì œì™¸ ê°€ëŠ¥"},
     {"name":"ì°¸ì¹˜ê¹€ë°¥","ingredients":["tuna","egg","mayonnaise"],"note":""}
   ]
  }
]
</pre></details>
        <textarea id="adminPaste" placeholder="ì—¬ê¸°ì— JSON ë˜ëŠ” ì¤„ë‹¨ìœ„ í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ê¸°"></textarea>
        <div class="row" style="gap:8px; margin-top:10px">
          <button class="btn" id="importJson">JSON ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button class="btn" id="importLines">ì¤„ë‹¨ìœ„ ë©”ë‰´ ì¶”ê°€</button>
          <button class="btn ghost" id="clearData">ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”</button>
        </div>
      </div>

      <div class="card">
        <h3>ì„ íƒ: ë©”ë‰´íŒ ì´ë¯¸ì§€ OCR (ì˜¨ë¼ì¸ì‹œ)</h3>
        <p class="muted">ì¸í„°ë„· ì—°ê²° ì‹œ <b>Tesseract.js</b> ë™ì  ë¡œë“œë¡œ ì´ë¯¸ì§€â†’í…ìŠ¤íŠ¸ ë³€í™˜.</p>
        <input id="ocrFile" type="file" accept="image/*" />
        <div class="row" style="gap:8px; margin:8px 0">
          <button class="btn" id="runOcr">OCR ì‹¤í–‰</button>
          <span id="ocrStatus" class="muted"></span>
        </div>
        <textarea id="ocrOut" placeholder="OCR ê²°ê³¼ í…ìŠ¤íŠ¸"></textarea>
      </div>
    </section>

    <!-- Prefs (sheet) -->
    <div class="sheet" id="sheet">
      <div class="handle"></div>
      <div class="row between" style="margin-bottom:6px">
        <h3 style="margin:0">í•„í„° & ê¸°ì¤€</h3>
        <button class="iconbtn" id="closeSheet" aria-label="ë‹«ê¸°">âœ•</button>
      </div>
      <div class="grid cols-2">
        <div>
          <div class="muted" style="margin:6px 0 4px">ì¢…êµÂ·ìœ¤ë¦¬ ê¸°ì¤€</div>
          <label class="row between"><span>Halal í•„ìš”(ì—„ê²©)</span><input type="checkbox" name="rule" value="halal"></label>
          <label class="row between"><span>Halal ì„ í˜¸(ìœ ì—°)</span><input type="checkbox" name="rule" value="halal_flexible"></label>
          <label class="row between"><span>Vegan</span><input type="checkbox" name="rule" value="vegan"></label>
          <label class="row between"><span>Vegetarian</span><input type="checkbox" name="rule" value="vegetarian"></label>
          <label class="row between"><span>Kosher</span><input type="checkbox" name="rule" value="kosher"></label>
        </div>
        <div>
          <div class="muted" style="margin:6px 0 4px">ì•Œë ˆë¥´ê¸°Â·íšŒí”¼ ì„±ë¶„</div>
          <div class="chips" id="avoidChips" style="flex-wrap:wrap">
            <div class="chip" data-avoid="pork">ë¼ì§€ê³ ê¸°</div>
            <div class="chip" data-avoid="alcohol">ì•Œì½”ì˜¬</div>
            <div class="chip" data-avoid="beef">ì†Œê³ ê¸°</div>
            <div class="chip" data-avoid="chicken">ë‹­ê³ ê¸°</div>
            <div class="chip" data-avoid="fish">ìƒì„ </div>
            <div class="chip" data-avoid="shellfish">ê°‘ê°ë¥˜</div>
            <div class="chip" data-avoid="dairy">ìœ ì œí’ˆ</div>
            <div class="chip" data-avoid="egg">ê³„ë€</div>
            <div class="chip" data-avoid="gluten">ê¸€ë£¨í…</div>
            <div class="chip" data-avoid="peanut">ë•…ì½©/ê²¬ê³¼</div>
            <div class="chip" data-avoid="gelatin">ì ¤ë¼í‹´</div>
            <div class="chip" data-avoid="fish_sauce">ì•¡ì “/ì–´ê°„ì¥</div>
          </div>
        </div>
      </div>
      <div class="row" style="gap:8px; margin-top:10px">
        <button class="btn" id="savePrefs">ì €ì¥í•˜ê³  ì ìš©</button>
        <button class="btn ghost" id="resetPrefs">ì´ˆê¸°í™”</button>
      </div>
    </div>
  </main>

  <!-- Bottom Tabs -->
  <nav class="tabs">
    <div class="tab active" data-tab="booths">ğŸ—ºï¸ <small>ë¶€ìŠ¤</small></div>
    <div class="tab" data-tab="detail">ğŸ“‹ <small>ìƒì„¸</small></div>
    <div class="tab" data-tab="admin">ğŸ› ï¸ <small>ê´€ë¦¬</small></div>
    <div class="tab" data-tab="share">ğŸ”— <small>ê³µìœ </small></div>
  </nav>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
  // ===================== STATE =====================
  const $ = (s,p=document)=>p.querySelector(s); const $$=(s,p=document)=>[...p.querySelectorAll(s)];
  const state = { lang:'ko', prefs:{rules:[], avoid:[]}, booths:[], activeBoothId:null, quick:{halalOnly:false, veganFriendly:false, allergenSafe:false} };

  const SAMPLE_BOOTHS=[
    { id:'B-01', name:'Kimbap House', halal_certified:false, vegan_certified:false,
      lat:37.5665, lng:126.9780, // ì˜ˆì‹œ ì¢Œí‘œ(ì„œìš¸)
      menus:[
        {name:'ì±„ì‹ê¹€ë°¥', tags:['vegetarian'], ingredients:['rice','seaweed','cucumber','carrot','spinach','sesame'], note:'ê³„ë€ ì œì™¸ ê°€ëŠ¥', src:'https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=400&q=80'},
        {name:'ì°¸ì¹˜ê¹€ë°¥', ingredients:['tuna','egg','mayonnaise'], src:'https://images.unsplash.com/photo-1464306076886-debede6b2f85?auto=format&fit=crop&w=400&q=80'},
        {name:'ê¹€ì¹˜ì „', ingredients:['kimchi','wheat_flour'], note:'ì¼ë¶€ ê¹€ì¹˜ëŠ” ì•¡ì “ í¬í•¨ ê°€ëŠ¥', src:'https://images.unsplash.com/photo-1519864600265-abb23847ef2c?auto=format&fit=crop&w=400&q=80'}],
      notes:['ì¼ë¶€ ë©”ë‰´ ê³„ë€/ë§ˆìš”ë„¤ì¦ˆ í¬í•¨','ê¹€ì¹˜ ì–´ë¥˜ ì„±ë¶„ ê°€ëŠ¥ì„± ì£¼ì˜'] },
    { id:'B-12', name:'Seoul BBQ Lab', halal_certified:false, vegan_certified:false,
      lat:37.5651, lng:126.9895,
      menus:[
        {name:'ë¶ˆê³ ê¸°', ingredients:['beef','soy_sauce','garlic','sugar','mirin'], note:'ì–‘ë…ì— ë§›ìˆ (ì•Œì½”ì˜¬) í¬í•¨ ê°€ëŠ¥', src:'https://images.unsplash.com/photo-1502741338009-cac2772e18bc?auto=format&fit=crop&w=400&q=80'},
        {name:'ë¼ì§€ê¹€ì¹˜ì°Œê°œ', ingredients:['pork','kimchi','gochujang','anchovy_broth'], note:'ë¼ì§€ê³ ê¸° Â· ë©¸ì¹˜ìœ¡ìˆ˜', src:'https://images.unsplash.com/photo-1519864600265-abb23847ef2c?auto=format&fit=crop&w=400&q=80'}],
      notes:['ë¼ì§€ê³ ê¸° ì·¨ê¸‰','ì•Œì½”ì˜¬ì„± ì¡°ë¯¸ë£Œ ê°€ëŠ¥ì„±'] },
    { id:'B-20', name:'Vegan Bibimbap', halal_certified:false, vegan_certified:true,
      lat:37.5678, lng:126.9770,
      menus:[
        {name:'ë¹„ê±´ ë¹„ë¹”ë°¥', tags:['vegan'], ingredients:['rice','veggie_mix','gochujang'], note:'ê³ ì¶”ì¥ì— ì£¼ì • ì„±ë¶„ ë¯¸ëŸ‰ í¬í•¨ ê°€ëŠ¥', src:'https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=400&q=80'},
        {name:'ë‘ë¶€ìŠ¤í…Œì´í¬', tags:['vegan'], ingredients:['tofu','soy_sauce','mushroom'], src:'https://images.unsplash.com/photo-1464306076886-debede6b2f85?auto=format&fit=crop&w=400&q=80'}],
      notes:['ì „ ë©”ë‰´ ë™ë¬¼ì„± ì›ì¬ë£Œ ì—†ìŒ(í‘œë°©)'] },
    { id:'B-33', name:'Halal Chicken & Tea', halal_certified:true, vegan_certified:false,
      lat:37.5640, lng:126.9820,
      menus:[
        {name:'Halal ì¹˜í‚¨ í”Œë ˆì´íŠ¸', tags:['halal'], ingredients:['chicken','rice','salad'], note:'í• ë„ ì¸ì¦ ë‹­ê³ ê¸°', src:'https://images.unsplash.com/photo-1502741338009-cac2772e18bc?auto=format&fit=crop&w=400&q=80'},
        {name:'ë°€í¬í‹°', ingredients:['milk','tea'], note:'ìœ ì œí’ˆ í¬í•¨', src:'https://images.unsplash.com/photo-1519864600265-abb23847ef2c?auto=format&fit=crop&w=400&q=80'}],
      notes:['í• ë„ ì¸ì¦ì„œ ë³´ìœ (í˜„ì¥ í‘œê¸°)'] }
  ];

  const KEYWORDS={
    pork:['pork','ham','bacon','ë¼ì§€','ë¼ì§€ê³ ê¸°','ì‚¼ê²¹','í–„'], alcohol:['alcohol','wine','mirin','cooking_wine','ìˆ ','ì²­ì£¼','ë¯¸ë¦¼','ë§›ìˆ '],
    beef:['beef','ì†Œê³ ê¸°','ì†Œë¶ˆê³ ê¸°','ì‚¬ê³¨'], chicken:['chicken','ë‹­','ì¹˜í‚¨'], fish:['fish','tuna','ì—°ì–´','fishcake','ì–´ë¬µ','ìƒì„ ','ë©¸ì¹˜','anchovy','bonito','ê°€ë‹¤ë‘ì–´'],
    shellfish:['shrimp','crab','ê²Œ','ìƒˆìš°','ì¡°ê°œ','êµ´','ì˜¤ì§•ì–´','ë¬¸ì–´'], dairy:['milk','cheese','butter','cream','yogurt','ìš°ìœ ','ì¹˜ì¦ˆ','ë²„í„°','í¬ë¦¼','ìš”ê±°íŠ¸'],
    egg:['egg','ê³„ë€','ë‹¬ê±€','ë§ˆìš”ë„¤ì¦ˆ','mayonnaise'], gluten:['wheat','flour','ë°€','ê¸€ë£¨í…','wheat_flour'], peanut:['peanut','ê²¬ê³¼','ë•…ì½©','í˜¸ë‘','ì•„ëª¬ë“œ','ìºìŠˆ'],
    gelatin:['gelatin','ì ¤ë¼í‹´','lard','ë¼ë“œ'], fish_sauce:['fish_sauce','ì•¡ì “','ì–´ê°„ì¥'] };

  const store={ get(k,f){try{return JSON.parse(localStorage.getItem(k))??f}catch(e){return f}}, set(k,v){localStorage.setItem(k,JSON.stringify(v))} };
  const toast=(m)=>{const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400)}
  // Surface runtime errors to UI
  window.addEventListener('error', (e)=>{ try{ console.error(e.error||e.message); }catch{} const t=document.querySelector('#toast'); if(t){ t.textContent='ì˜¤ë¥˜: '+(e.message||'script'); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2200); } });

  // ===================== INIT =====================
  function init(){
    // Theme
    const prefersLight = matchMedia && matchMedia('(prefers-color-scheme: light)').matches;
    const savedTheme = store.get('sdn_theme', prefersLight? 'light':'dark');
    document.documentElement.classList.toggle('light', savedTheme==='light');

    // Language
    const savedLang=store.get('sdn_lang',null)||(navigator.language||'ko').slice(0,2); state.lang=['ko','en','ar'].includes(savedLang)?savedLang:'ko';
    document.documentElement.lang=state.lang; document.documentElement.dir=state.lang==='ar'?'rtl':'ltr';
    $('#lang').value=state.lang;

    // Data
    state.prefs=store.get('sdn_prefs',{rules:[], avoid:[]});
    const savedBooths = store.get('sdn_booths', null);
    state.booths = (Array.isArray(savedBooths) && savedBooths.length) ? savedBooths : SAMPLE_BOOTHS;
    store.set('sdn_booths', state.booths);

    // Deep-link ?booth=
    const url=new URL(location.href); const boothId=url.searchParams.get('booth');
    if(boothId){ state.activeBoothId=boothId; switchTab('detail'); renderDetail(boothId); } else { switchTab('booths'); renderBoothList(); }

    hydrateSheet();
  }

  // ===================== PREFS & SHEET =====================
  function hydrateSheet(){
    $$('input[name="rule"]').forEach(ch=> ch.checked = state.prefs.rules.includes(ch.value));
    $$('#avoidChips .chip').forEach(ch=> ch.classList.toggle('active', state.prefs.avoid.includes(ch.dataset.avoid)));
  }

  function savePrefs(){
    const rules=$$('input[name="rule"]:checked').map(ch=>ch.value);
    const avoid=$$('#avoidChips .chip.active').map(ch=>ch.dataset.avoid);
    state.prefs={rules, avoid}; store.set('sdn_prefs',state.prefs); toast('ê¸°ì¤€ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤');
    renderBoothList(); closeSheet();
  }

  function resetPrefs(){ state.prefs={rules:[], avoid:[]}; store.set('sdn_prefs',state.prefs); hydrateSheet(); toast('ê¸°ì¤€ ì´ˆê¸°í™”'); renderBoothList(); }

  // Click to toggle avoid chips
  function wireAvoidChips(){ $$('#avoidChips .chip').forEach(ch=> ch.onclick=()=> ch.classList.toggle('active')); }

  // ===================== SAFETY EVAL =====================
  function evaluateMenuSafety(menu,prefs){
    const reasons=[]; const txt=((menu.name||'')+' '+(menu.note||'')+' '+(menu.ingredients||[]).join(' ')).toLowerCase();
    for(const k of prefs.avoid){ const words=KEYWORDS[k]||[]; if(words.some(w=>txt.includes(w))) reasons.push(`íšŒí”¼ ì„±ë¶„ í¬í•¨: ${k}`); }
    let veganFail=false, vegetarianFail=false; const animal=[...KEYWORDS.beef,...KEYWORDS.chicken,...KEYWORDS.pork,...KEYWORDS.fish,...KEYWORDS.shellfish,...KEYWORDS.gelatin].filter(Boolean); const dairyEgg=[...KEYWORDS.dairy,...KEYWORDS.egg].filter(Boolean);
    if(prefs.rules.includes('vegan')){ if(animal.some(w=>txt.includes(w))||dairyEgg.some(w=>txt.includes(w))) {veganFail=true; reasons.push('ë¹„ê±´ ë¶ˆê°€ ì„±ë¶„ ì¡´ì¬')} if((KEYWORDS.fish_sauce||[]).some(w=>txt.includes(w))) reasons.push('ë¹„ê±´ ì£¼ì˜: ì•¡ì “ ê°€ëŠ¥ì„±'); }
    if(prefs.rules.includes('vegetarian')){ if(animal.some(w=>txt.includes(w))) {vegetarianFail=true; reasons.push('ë² ì§€í…Œë¦¬ì–¸ ë¶ˆê°€ ì„±ë¶„ ì¡´ì¬')} }
    let halalFail=false, halalCaution=false; if(prefs.rules.includes('halal')||prefs.rules.includes('halal_flexible')){
      if((KEYWORDS.pork||[]).some(w=>txt.includes(w))) {halalFail=true; reasons.push('í• ë„ ê¸ˆì§€: ë¼ì§€ê³ ê¸°')} if((KEYWORDS.alcohol||[]).some(w=>txt.includes(w))) {halalFail=true; reasons.push('í• ë„ ê¸ˆì§€: ì•Œì½”ì˜¬/ë§›ìˆ ')}
      const hasBeef=(KEYWORDS.beef||[]).some(w=>txt.includes(w)); const hasChicken=(KEYWORDS.chicken||[]).some(w=>txt.includes(w));
      if((hasBeef||hasChicken) && !(menu.tags||[]).includes('halal')){ if(prefs.rules.includes('halal')) {halalFail=true; reasons.push('í• ë„ ë¯¸í™•ì¸ ìœ¡ë¥˜')} else {halalCaution=true; reasons.push('í• ë„ ë¯¸í™•ì¸ ìœ¡ë¥˜ (ìœ ì—°)')} }
    }
    let score=100; if(reasons.some(r=>/ê¸ˆì§€|ë¶ˆê°€|íšŒí”¼/.test(r))) score-=70; if(reasons.some(r=>/ì£¼ì˜/.test(r))) score-=25; let status='ok'; if(score<50||veganFail||vegetarianFail||halalFail) status='bad'; else if(score<80||halalCaution) status='warn';
    return {status, score, reasons};
  }

  function boothOverallStatus(booth,prefs){ let anyOk=false, anyWarn=false, anyBad=false; for(const m of (booth.menus||[])){ const ev=evaluateMenuSafety(m,prefs); if(ev.status==='ok') anyOk=true; if(ev.status==='warn') anyWarn=true; if(ev.status==='bad') anyBad=true; } return anyOk?'ok':(anyWarn?'warn':'bad'); }
  const badge=(s)=>`<span class="status ${s}">â— ${s==='ok'?'ì•ˆì „':s==='warn'?'ì£¼ì˜':'íšŒí”¼'}</span>`;

  // ===================== RENDER LIST =====================
  function applyQuick(list){ const { halalOnly, veganFriendly, allergenSafe }=state.quick; let out=list.slice(); if(halalOnly){ out=out.filter(b=> b.halal_certified || (b.menus||[]).some(m=> (m.tags||[]).includes('halal')) ); } if(veganFriendly){ out=out.filter(b=> b.vegan_certified || (b.menus||[]).some(m=> (m.tags||[]).includes('vegan')) ); } if(allergenSafe && state.prefs.avoid.length){ out=out.filter(b=> (b.menus||[]).some(m=> !state.prefs.avoid.some(a=> (KEYWORDS[a]||[]).some(w=> ((m.name||'')+' '+(m.note||'')+' '+(m.ingredients||[]).join(' ')).toLowerCase().includes(w))) )); } return out; }

  function renderSummary(list){ const prefsActive=!!(state.prefs.rules.length||state.prefs.avoid.length); let ok=0,warn=0,bad=0; for(const b of list){ const s=prefsActive?boothOverallStatus(b,state.prefs):'warn'; if(s==='ok') ok++; else if(s==='warn') warn++; else bad++; } $('#summary').textContent=`ì´ ${list.length}ë¶€ìŠ¤ Â· ì•ˆì „ ${ok} Â· ì£¼ì˜ ${warn} Â· íšŒí”¼ ${bad}`; }

  function renderBoothList(){ const cont=$('#boothContainer'); cont.innerHTML=''; let list=state.booths; const q=($('#q').value||'').toLowerCase().trim(); if(q){ list=list.filter(b=> b.name.toLowerCase().includes(q) || (b.menus||[]).some(m=> ((m.name||'')+' '+(m.ingredients||[]).join(' ')).toLowerCase().includes(q)) ); }
    list=applyQuick(list); const useFilter=!!(state.prefs.rules.length||state.prefs.avoid.length); renderSummary(list); if(!list.length){ $('#emptyState').style.display='block'; return } else { $('#emptyState').style.display='none' }
    list.forEach(booth=>{ const st=useFilter?boothOverallStatus(booth,state.prefs):'warn'; const tags=[]; if(booth.halal_certified) tags.push('<span class="chip">Halal Certified</span>'); if(booth.vegan_certified) tags.push('<span class="chip">Vegan</span>'); // ëŒ€í‘œ ë©”ë‰´ ì‚¬ì§„(ì²« ë©”ë‰´ src)
      const img = booth.menus?.[0]?.src ? `<img src="${booth.menus[0].src}" alt="menu" style="width:80px;height:80px;object-fit:cover;border-radius:12px;margin-right:12px;">` : '';
      const el=document.createElement('div'); el.className='card booth'; el.innerHTML=`${img}<div class="meta"><div class="row between"><h3>${booth.name}</h3>${badge(st)}</div><div class="chips" style="margin:6px 0 2px">${tags.join(' ')}</div><div class="muted">ID: ${booth.id}</div><div class="row" style="gap:8px; margin-top:8px"><button class="btn sm" data-open="${booth.id}">ìƒì„¸ë³´ê¸°</button><button class="btn ghost sm" data-copy="${booth.id}">ë§í¬ë³µì‚¬</button></div></div>`; cont.appendChild(el); });
    $$('[data-open]').forEach(b=> b.onclick=()=>{ const id=b.getAttribute('data-open'); state.activeBoothId=id; renderDetail(id); switchTab('detail'); history.replaceState(null,'',`?booth=${id}`) });
    $$('[data-copy]').forEach(b=> b.onclick=async()=>{ const id=b.getAttribute('data-copy'); const url=location.origin+location.pathname+`?booth=${encodeURIComponent(id)}`; try{ await navigator.clipboard.writeText(url); toast('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤') }catch{ prompt('ë³µì‚¬í•˜ì„¸ìš”', url) } });
    renderMap(); // ì§€ë„ë„ ê°™ì´ ë Œë”
  }

  // ì§€ë„ ë Œë”ë§ í•¨ìˆ˜ ì¶”ê°€
  function renderMap(){
    const booths = state.booths;
    if (!booths.length) return;
    // ì§€ë„ ì¤‘ì‹¬ ì¢Œí‘œ(ì²« ë¶€ìŠ¤ ê¸°ì¤€)
    const center = booths.length ? {lat:booths[0].lat, lng:booths[0].lng} : {lat:37.5665, lng:126.9780};
    const zoom = 16;
    // ì§€ë„ iframe
    $('#mapContainer').innerHTML = `
      <iframe
        src="https://www.openstreetmap.org/export/embed.html?bbox=${center.lng-0.01},${center.lat-0.008},${center.lng+0.01},${center.lat+0.008}&layer=mapnik"
        style="width:100%;height:100%;border:0;"
        allowfullscreen
        loading="lazy"
      ></iframe>
      <div id="mapMarkers" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;"></div>
    `;
    // ë§ˆì»¤ ì˜¤ë²„ë ˆì´
    const mapDiv = $('#mapContainer');
    const markerDiv = mapDiv.querySelector('#mapMarkers');
    markerDiv.style.pointerEvents = 'auto';
    // ë§ˆì»¤ ìœ„ì¹˜ ê³„ì‚° (ê°„ë‹¨í•œ ìƒëŒ€ì¢Œí‘œ, ì‹¤ì œ ì§€ë„ì™€ ì •í™•íˆ ì¼ì¹˜í•˜ì§€ ì•ŠìŒ)
    markerDiv.innerHTML = booths.map(b=>{
      // x, y ê³„ì‚° (ì§€ë„ bbox ê¸°ì¤€)
      const x = ((b.lng-(center.lng-0.01))/0.02)*mapDiv.offsetWidth;
      const y = ((center.lat+0.008-b.lat)/0.016)*mapDiv.offsetHeight;
      return `<div style="position:absolute;left:${x}px;top:${y}px;transform:translate(-50%,-100%);cursor:pointer;z-index:2;" data-booth="${b.id}">
        <span style="background:#4f7cff;color:#fff;padding:4px 8px;border-radius:8px;font-weight:700;font-size:13px;box-shadow:0 2px 8px rgba(0,0,0,.18);">${b.name}</span>
      </div>`;
    }).join('');
    // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
    markerDiv.querySelectorAll('[data-booth]').forEach(el=>{
      el.onclick = (e)=>{
        const id = el.getAttribute('data-booth');
        state.activeBoothId = id;
        renderDetail(id);
        switchTab('detail');
        history.replaceState(null,'',`?booth=${id}`);
        e.stopPropagation();
      };
    });
  }

  // ===================== DETAIL =====================
  function renderDetail(id){
    const cont=$('#view-detail');
    const booth=state.booths.find(b=>b.id===id) || state.booths[0];
    if(!booth) return;
    const menus=(booth.menus||[]).map(m=>{
      const ev=evaluateMenuSafety(m,state.prefs);
      const tags=(m.tags||[]).map(t=>`<span class="chip">${t}</span>`).join(' ');
      const reasons=ev.reasons.length?`<div class="muted" style="margin-top:6px">â€¢ ${ev.reasons.join('<br>â€¢ ')}</div>`:'';
      // ë©”ë‰´ ì‚¬ì§„ì´ ì—†ìœ¼ë©´ placeholder ì´ë¯¸ì§€ ì‚¬ìš©
      const imgSrc = m.src || 'https://via.placeholder.com/320x200?text=No+Image';
      const img = `<img src="${imgSrc}" alt="menu" style="width:100%;max-width:320px;height:auto;object-fit:cover;border-radius:12px;margin-bottom:8px;">`;
      return `<div class="card">
        ${img}
        <div class="row between"><h3>${m.name}</h3>${badge(ev.status)}</div>
        <div class="chips" style="margin:6px 0">${tags}</div>
        <div class="muted">${(m.ingredients||[]).join(', ')||'ingredients N/A'}</div>
        ${m.note?`<div class="muted" style="margin-top:6px">Note: ${m.note}</div>`:''}
        <div class="row" style="gap:8px; margin-top:8px"><button class="btn sm" data-log="${booth.id}::${m.name}">ì´ ë©”ë‰´ ë¨¹ì—ˆì–´ìš”</button></div>
        ${reasons}
      </div>`;
    }).join('');
    const notes=(booth.notes||[]).length?`<div class="muted">${booth.notes.map(n=>'â€¢ '+n).join('<br>')}</div>`:'';
    cont.innerHTML=`<div class="card"><div class="row between"><div><h2 style="margin:0">${booth.name}</h2><div class="chips" style="margin-top:6px">${booth.halal_certified?'<span class="chip">Halal Certified</span>':''}${booth.vegan_certified?'<span class="chip">Vegan</span>':''}</div></div><div>${badge(boothOverallStatus(booth,state.prefs))}</div></div><div style="margin-top:6px">${notes}</div></div>${menus||'<div class="card">ë“±ë¡ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤</div>'}<div class="card"><h3>ë‚´ ì‹ì‚¬ ê¸°ë¡</h3><div id="history"></div></div>`;
    renderHistory();
    $$('[data-log]').forEach(b=> b.onclick=()=>{ const [bid,mname]=b.getAttribute('data-log').split('::'); const hist=store.get('sdn_history',[]); hist.unshift({ts:Date.now(), boothId:bid, menu:mname}); store.set('sdn_history',hist); renderHistory(); toast('ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤') });
  }

  function renderHistory(){ const hist=store.get('sdn_history',[]); const el=$('#history'); if(!el) return; if(!hist.length){ el.innerHTML='<div class="muted">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>'; return } el.innerHTML=hist.map(h=>{ const d=new Date(h.ts).toLocaleString(); return `<div class="row between" style="padding:8px 0; border-bottom:1px dashed var(--border)"><div>${d}</div><div class="muted">${h.boothId}</div><div><b>${h.menu}</b></div></div>` }).join(''); }

  // ===================== ADMIN IMPORT =====================
  function importJson(){ try{ const arr=JSON.parse($('#adminPaste').value.trim()); if(!Array.isArray(arr)) throw new Error('Array JSON í•„ìš”'); const map=new Map(state.booths.map(b=>[b.id,b])); for(const b of arr){ map.set(b.id,b) } state.booths=[...map.values()]; store.set('sdn_booths',state.booths); toast('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ'); renderBoothList(); }catch(e){ alert('JSON íŒŒì‹± ì˜¤ë¥˜: '+e.message) } }
  function importLines(){
    const text = $('#adminPaste').value || '';
    // â†“ ì •ê·œì‹ ì˜¤ë¥˜ ìˆ˜ì •: ì¤„ë°”ê¿ˆ ê¸°ì¤€ ë¶„ë¦¬
    const lines = text.split(/\r?\n+/).map(s=>s.trim()).filter(Boolean);
    const map = new Map(state.booths.map(b=>[b.id,b]));
    for (const line of lines){
      const [id,name,rest] = line.split('|').map(s=>s?.trim());
      if(!id||!name||!rest) continue;
      const parts = rest.split(',').map(x=>x.trim());
      const menuName = parts.shift();
      const ing = parts;
      const booth = map.get(id) || {id, name, halal_certified:false, vegan_certified:false, menus:[], notes:[]};
      booth.menus.push({name:menuName, ingredients:ing});
      map.set(id, booth);
    }
    state.booths = [...map.values()];
    store.set('sdn_booths', state.booths);
    toast('ì¤„ë‹¨ìœ„ ì…ë ¥ ì™„ë£Œ');
    renderBoothList();
  }
  function clearData(){ if(confirm('ëª¨ë“  ë¶€ìŠ¤/ê¸°ë¡ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?')){ localStorage.removeItem('sdn_booths'); localStorage.removeItem('sdn_history'); state.booths=SAMPLE_BOOTHS; store.set('sdn_booths',state.booths); renderBoothList(); toast('ì´ˆê¸°í™” ì™„ë£Œ'); } }

  // ===================== SHEET CONTROL =====================
  const openSheet=()=> $('#sheet').classList.add('open'); const closeSheet=()=> $('#sheet').classList.remove('open');

  // ===================== EVENTS =====================
  $('#lang').onchange=(e)=>{ state.lang=e.target.value; store.set('sdn_lang',state.lang); document.documentElement.lang=state.lang; document.documentElement.dir=state.lang==='ar'?'rtl':'ltr'; toast('ì–¸ì–´ ë³€ê²½ë¨'); };
  $('#openSheet').onclick=openSheet; $('#openSheetTop').onclick=openSheet; $('#closeSheet').onclick=closeSheet;
  $('#savePrefs').onclick=savePrefs; $('#resetPrefs').onclick=resetPrefs;
  $('#q').oninput=renderBoothList;
  $$('#quickChips .chip').forEach(c=> c.onclick=()=>{ const k=c.dataset.quick; state.quick[k]=!state.quick[k]; c.classList.toggle('active', state.quick[k]); renderBoothList(); });
  wireAvoidChips();

  $$('.tab').forEach(t=> t.onclick=()=>{ const tab=t.dataset.tab; $$('.tab').forEach(x=>x.classList.toggle('active', x===t)); switchTab(tab); });
  function switchTab(name){ $('#view-booths').style.display = name==='booths'?'block':'none'; $('#view-detail').style.display = name==='detail'?'block':'none'; $('#view-admin').style.display = name==='admin'?'block':'none'; if(name==='share'){ doShare(); $$('.tab').find(x=>x.dataset.tab==='booths').click(); } if(name==='booths') renderBoothList(); if(name==='detail' && state.activeBoothId) renderDetail(state.activeBoothId); }

  $('#btnExport').onclick=()=>{ const payload={ prefs:state.prefs, booths:state.booths, history:store.get('sdn_history',[]) }; const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='sdn-food-filter-export.json'; a.click(); URL.revokeObjectURL(url); };
  $('#btnTheme').onclick=()=>{ const cur = document.documentElement.classList.contains('light')?'light':'dark'; const next = cur==='light'?'dark':'light'; document.documentElement.classList.toggle('light', next==='light'); store.set('sdn_theme', next); toast(next==='light'?'ë¼ì´íŠ¸ ëª¨ë“œ':'ë‹¤í¬ ëª¨ë“œ'); };
  $('#seedData').onclick=()=>{ localStorage.removeItem('sdn_booths'); state.booths = SAMPLE_BOOTHS; store.set('sdn_booths', state.booths); renderBoothList(); toast('ìƒ˜í”Œ ë°ì´í„°ê°€ ì¬ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤'); };

  async function doShare(){ try{ const url=location.href; if(navigator.share){ await navigator.share({ title:'SDN Food Booth Filter', url }); } else { await navigator.clipboard.writeText(url); toast('ë§í¬ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆì–´ìš”') } } catch(e){ toast('ê³µìœ ê°€ ì·¨ì†Œë˜ì—ˆì–´ìš”') } }

  // OCR
  $('#importJson')?.addEventListener('click', importJson);
  $('#importLines')?.addEventListener('click', importLines);
  $('#clearData')?.addEventListener('click', clearData);
  $('#runOcr')?.addEventListener('click', async()=>{
    const file=$('#ocrFile').files?.[0]; if(!file){ alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”'); return }
    $('#ocrStatus').textContent='Tesseract.js ë¡œë”© ì¤‘...'; try{ if(!window.Tesseract){ await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js'; s.onload=res; s.onerror=rej; document.body.appendChild(s) }); }
      $('#ocrStatus').textContent='ì¸ì‹ ì¤‘...'; const imgUrl=URL.createObjectURL(file); const result=await Tesseract.recognize(imgUrl, state.lang==='ko'?'kor':'eng'); $('#ocrOut').value=result?.data?.text||''; $('#ocrStatus').textContent='ì™„ë£Œ'; } catch(e){ $('#ocrStatus').textContent='ì‹¤íŒ¨'; alert('OCR ì‹¤íŒ¨: '+e.message) }
  });

  // START
  init();

  </script>
</body>
</html>
